<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>JOGO TOP — BATTLE ROYALE (Prototype)</title>
<style>
  :root{--accent:#1f6feb;--danger:#ff4b4b}
  html,body{height:100%;margin:0;background:#020617;font-family:Inter,Arial,Helvetica,sans-serif;overflow:hidden}
  #wrap{position:fixed;inset:0}
  canvas{display:block}
  #hud{position:fixed;left:50%;top:10px;transform:translateX(-50%);z-index:999;color:#fff;background:rgba(0,0,0,0.45);padding:8px 12px;border-radius:10px;font-weight:700;display:flex;gap:10px;align-items:center}
  #leftHud{position:fixed;left:10px;top:10px;z-index:999;color:#fff}
  #rightHud{position:fixed;right:10px;top:10px;z-index:999;color:#fff;display:flex;flex-direction:column;gap:8px}
  #cross{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:20px;height:20px;z-index:999;pointer-events:none}
  #cross:after{content:'';position:absolute;left:50%;top:50%;width:2px;height:16px;background:#fff;transform:translate(-50%,-50%)}
  #cross:before{content:'';position:absolute;left:50%;top:50%;width:16px;height:2px;background:#fff;transform:translate(-50%,-50%)}
  #shootBtn{position:fixed;right:12px;bottom:16px;width:84px;height:84px;border-radius:50%;background:linear-gradient(145deg,var(--danger),#b00000);border:none;color:#fff;font-size:16px;z-index:999}
  #joy{position:fixed;left:12px;bottom:12px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,0.04);z-index:999;touch-action:none}
  #stick{width:60px;height:60px;background:linear-gradient(180deg,#fff,#ddd);border-radius:50%;position:absolute;left:40px;top:40px;opacity:.95}
  #start{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.75),rgba(0,0,0,0.85));z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff}
  #start button{padding:14px 28px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:800;font-size:18px}
  #panel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:2001;background:rgba(3,7,12,0.95);color:#fff;padding:18px;border-radius:12px;display:none;max-width:92%;width:780px}
  .btnMini{background:rgba(255,255,255,0.06);border:none;color:#fff;padding:8px 10px;border-radius:10px;font-weight:700}
  #log{position:fixed;left:12px;bottom:164px;color:#fff;z-index:999;font-size:13px}
  @media (max-width:520px){
    #panel{width:94%}
    #joy{width:120px;height:120px} #stick{width:52px;height:52px;left:34px;top:34px}
    #shootBtn{width:72px;height:72px}
  }
</style>
</head>
<body>
<div id="wrap"></div>

<div id="start">
  <h1 style="margin:0 0 10px 0">JOGO TOP — BATTLE ROYALE</h1>
  <p style="opacity:0.85;max-width:600px;text-align:center">Prototype Battle Royale — toque para iniciar. Joystick à esquerda, atirar à direita. Zona encolhe, loot, bots e armas.</p>
  <div style="height:12px"></div>
  <button id="startBtn">INICIAR PARTIDA</button>
  <div style="height:8px"></div>
  <small style="opacity:0.7">Protótipo técnico — para publicação, integre servidor multiplayer.</small>
</div>

<div id="hud">
  <div>Vida: <span id="life">100</span></div>
  <div style="width:8px"></div>
  <div>Pontos: <span id="score">0</span></div>
  <div style="width:8px"></div>
  <div>Jogadores: <span id="players">0</span></div>
  <div style="width:8px"></div>
  <div>Zona: <span id="zone">100%</span></div>
</div>

<div id="leftHud"></div>
<div id="rightHud">
  <button id="btnShop" class="btnMini">Loja</button>
  <button id="btnRestart" class="btnMini">Reiniciar</button>
</div>

<div id="cross"></div>
<button id="shootBtn">TIRO</button>
<div id="joy"><div id="stick"></div></div>
<div id="log"></div>

<!-- Panel (Loja / Fim) -->
<div id="panel"><h2 id="panelTitle">Loja</h2><div id="panelBody"></div><div style="text-align:right;margin-top:12px"><button id="closePanel" class="btnMini">Fechar</button></div></div>

<!-- three.js -->
<script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.154.0/examples/js/controls/PointerLockControls.js"></script>

<script>
/* =========================
   Battle Royale Prototype
   - Map grande (generativo)
   - Jogador FP
   - Bots simulando outros jogadores (configurável)
   - Loot crates
   - Zona segura encolhendo (circle)
   - Joystick + botão de tiro
   - Texturas opcionais / gráficos escaláveis
   - Tudo em um arquivo HTML
   =========================*/

/* -------- CONFIG -------- */
const CONFIG = {
  MAX_BOTS: 30,              // padrão; para testes móveis mantenha 10-30; para PC pode aumentar (simula jogadores)
  MAP_RADIUS: 200,           // raio do mapa em unidades
  START_SAFE_RADIUS: 150,    // raio inicial da zona
  SAFE_SHRINK_STEPS: 6,      // quantas vezes a zona vai encolher
  SAFE_SHRINK_INTERVAL: 20000, // ms entre encolhimentos (20s)
  SAFE_MIN_RADIUS: 20,
  BOT_SPAWN_INTERVAL: 1800,
  PROJECTILE_SPEED: 320,
  PLAYER_MAX_LIFE: 100,
  PLAYER_SPEED: 18,
  PLAYER_SPRINT_MULT: 1.8,
  PERFORMANCE_MODE: false // se true, reduz qualidade automaticamente
};

/* allow toggling textures on/off for low-end devices */
let USE_TEXTURES = true;

/* -------- DOM -------- */
const wrap = document.getElementById('wrap');
const startBtn = document.getElementById('startBtn');
const lifeEl = document.getElementById('life');
const scoreEl = document.getElementById('score');
const playersEl = document.getElementById('players');
const zoneEl = document.getElementById('zone');
const shootBtn = document.getElementById('shootBtn');
const joy = document.getElementById('joy');
const stick = document.getElementById('stick');
const startOverlay = document.getElementById('start');
const logEl = document.getElementById('log');
const panel = document.getElementById('panel');
const panelTitle = document.getElementById('panelTitle');
const panelBody = document.getElementById('panelBody');
const closePanel = document.getElementById('closePanel');
const btnShop = document.getElementById('btnShop');
const btnRestart = document.getElementById('btnRestart');

/* -------- THREE.js scene -------- */
let scene, camera, renderer, controls;
let clock = new THREE.Clock();
let running = false, paused = false;
let player = { life: CONFIG.PLAYER_MAX_LIFE, speed: CONFIG.PLAYER_SPEED, sprint:false };
let weaponMesh;
let projectiles = [], bots = [], crates = [], particles = [];
let safeZone = { center: new THREE.Vector2(0,0), radius: CONFIG.START_SAFE_RADIUS, targetRadius: CONFIG.START_SAFE_RADIUS };
let score = 0, totalPlayers = 1;
let lastBotSpawn = 0;
let lastShrinkTime = 0;
let shrinkStep = 0;

/* performance auto-detect (simple) */
function detectPerformance(){
  const mem = navigator.deviceMemory || 2;
  const cores = navigator.hardwareConcurrency || 2;
  if(mem <= 2 || cores <= 2) { CONFIG.PERFORMANCE_MODE = true; USE_TEXTURES = false; }
}
detectPerformance();

/* init three */
function initThree(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b1220);
  camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 2000);
  camera.position.set(0, 1.6, 8);
  renderer = new THREE.WebGLRenderer({ antialias: !CONFIG.PERFORMANCE_MODE, alpha:false });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  wrap.appendChild(renderer.domElement);
  // lights
  const hemi = new THREE.HemisphereLight(0xffffff, 0x111122, 0.8); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(-50,80,50); scene.add(dir);
  // fog for depth
  scene.fog = new THREE.FogExp2(0x0b1220, 0.0012);
  // ground
  const groundMat = new THREE.MeshStandardMaterial({ color: 0x053040, roughness: 0.95 });
  if(USE_TEXTURES){
    // simple procedural-looking texture using canvas (optional)
    const gCanvas = document.createElement('canvas'); gCanvas.width=512; gCanvas.height=512;
    const gCtx = gCanvas.getContext('2d'); gCtx.fillStyle='#063443'; gCtx.fillRect(0,0,512,512);
    for(let i=0;i<800;i++){ gCtx.fillStyle='rgba(0,0,0,0.02)'; gCtx.fillRect(Math.random()*512,Math.random()*512,1,1); }
    groundMat.map = new THREE.CanvasTexture(gCanvas);
    groundMat.map.wrapS = groundMat.map.wrapT = THREE.RepeatWrapping;
    groundMat.map.repeat.set(20,20);
  }
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(CONFIG.MAP_RADIUS*2, CONFIG.MAP_RADIUS*2, 64,64), groundMat);
  ground.rotation.x = -Math.PI/2; ground.position.y = 0; scene.add(ground);
  // simple sky hemisphere
  const skyGeo = new THREE.SphereGeometry(1000, 16, 12);
  const skyMat = new THREE.MeshBasicMaterial({ color: 0x071028, side: THREE.BackSide });
  scene.add(new THREE.Mesh(skyGeo, skyMat));
  // map objects: add rocks/buildings
  buildMap();
  window.addEventListener('resize', onResize);
}

/* build simple map (buildings & covers) */
function buildMap(){
  const coverMat = new THREE.MeshStandardMaterial({ color: 0x223344, roughness: 0.9 });
  // generate roofs/buildings
  for(let i=0;i<40;i++){
    const w = 4 + Math.random()*15;
    const h = 2 + Math.random()*12;
    const d = 4 + Math.random()*12;
    const geo = new THREE.BoxGeometry(w,h,d);
    const mat = new THREE.MeshStandardMaterial({ color: 0x1b2630 + Math.floor(Math.random()*0x001122), roughness:0.9 });
    const b = new THREE.Mesh(geo, mat);
    const ang = Math.random()*Math.PI*2; const r = 20 + Math.random()*CONFIG.MAP_RADIUS*0.6;
    b.position.set(Math.cos(ang)*r, h/2 - 0.1, Math.sin(ang)*r);
    b.rotation.y = Math.random()*Math.PI*2;
    scene.add(b);
  }
  // crates / loot spawns
  for(let i=0;i<60;i++){
    if(Math.random() < 0.6) continue;
    const c = createCrate();
    const ang = Math.random()*Math.PI*2; const r = 10 + Math.random()*CONFIG.MAP_RADIUS*0.9;
    c.position.set(Math.cos(ang)*r, 0.3, Math.sin(ang)*r);
    scene.add(c); crates.push(c);
  }
}

/* create crate mesh */
function createCrate(){
  const geo = new THREE.BoxGeometry(0.8,0.8,0.8);
  const mat = new THREE.MeshStandardMaterial({ color: 0x664422, metalness: 0.1 });
  const m = new THREE.Mesh(geo, mat);
  m.userData = { loot: randomLoot() };
  return m;
}
function randomLoot(){
  const pool = ['Pistol','SMG','AR','Shotgun','Medkit','Armor'];
  return pool[Math.floor(Math.random()*pool.length)];
}

/* create simple player weapon mesh */
function createWeaponMesh(){
  const g = new THREE.Group();
  const body = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.16,1.1), new THREE.MeshStandardMaterial({ color: 0x23313f, metalness:0.5 }));
  body.position.set(0,-0.2,-0.5); g.add(body);
  const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.9,8), new THREE.MeshStandardMaterial({ color:0x5a6066 }));
  barrel.rotation.x = Math.PI/2; barrel.position.set(0,-0.18,-1.1); g.add(barrel);
  return g;
}

/* spawn a bot (simulated player) */
function spawnBot(){
  const geo = new THREE.CapsuleGeometry(0.45, 0.6, 4, 8);
  const mat = new THREE.MeshStandardMaterial({ color: 0xcc3344 });
  const m = new THREE.Mesh(geo, mat);
  const ang = Math.random()*Math.PI*2; const r = 20 + Math.random()*CONFIG.MAP_RADIUS*0.8;
  m.position.set(Math.cos(ang)*r, 0.8, Math.sin(ang)*r);
  m.userData = { hp: 50 + Math.floor(Math.random()*50), speed: 3 + Math.random()*2, state: 'roam', target: null };
  scene.add(m); bots.push(m);
  totalPlayers = 1 + bots.length;
  playersEl.textContent = totalPlayers;
}

/* shoot projectile from camera */
function spawnProjectile(){
  // small audio feedback (vibration)
  navigator.vibrate?.(18);
  const g = new THREE.SphereGeometry(0.06, 8,8);
  const m = new THREE.Mesh(g, new THREE.MeshStandardMaterial({ emissive:0xffffcc, emissiveIntensity:1 }));
  const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion).normalize();
  m.position.copy(camera.position).add(dir.clone().multiplyScalar(1.2));
  m.userData = { vel: dir.clone().multiplyScalar(CONFIG.PROJECTILE_SPEED), life: 3 };
  scene.add(m); projectiles.push(m);
  // muzzle flash
  const f = new THREE.Mesh(new THREE.SphereGeometry(0.08,6,6), new THREE.MeshStandardMaterial({ emissive:0xffddaa, emissiveIntensity:1 }));
  f.position.copy(m.position); scene.add(f); setTimeout(()=>scene.remove(f),60);
}

/* projectile collisions */
function updateProjectiles(dt){
  for(let i=projectiles.length-1;i>=0;i--){
    const p = projectiles[i];
    p.position.addScaledVector(p.userData.vel, dt);
    p.userData.life -= dt;
    // check collision with bots
    for(let j=bots.length-1;j>=0;j--){
      const b = bots[j];
      if(b.position.distanceTo(p.position) < 0.8){
        b.userData.hp -= 35;
        // hit effect
        spawnHitEffect(p.position);
        scene.remove(p); projectiles.splice(i,1);
        if(b.userData.hp <= 0){
          // bot killed
          spawnLootAt(b.position);
          scene.remove(b); bots.splice(j,1); totalPlayers = 1 + bots.length; playersEl.textContent = totalPlayers;
          score += 10; scoreEl.textContent = score;
        }
        break;
      }
    }
    if(p && p.userData.life <= 0){ scene.remove(p); projectiles.splice(i,1); }
  }
}

/* bots AI simple */
function updateBots(dt){
  for(let i=bots.length-1;i>=0;i--){
    const b = bots[i];
    // if far from center, wander
    if(!b.userData.target || Math.random()<0.005) {
      const ang = Math.random()*Math.PI*2; const r = 2 + Math.random()*40;
      b.userData.target = new THREE.Vector3(Math.cos(ang)*r, 0, Math.sin(ang)*r);
    }
    const dir = b.userData.target.clone().sub(b.position); dir.y = 0;
    if(dir.length() > 0.5) {
      dir.normalize();
      b.position.addScaledVector(dir, b.userData.speed * dt);
    } else {
      b.userData.target = null;
    }
    // simple aggression: if player is near, move towards and occasionally shoot (simulated)
    if(b.position.distanceTo(camera.position) < 12){
      const dirP = camera.position.clone().sub(b.position); dirP.y=0; dirP.normalize();
      b.position.addScaledVector(dirP, b.userData.speed * 1.2 * dt);
      // occasionally "shoot" at player: reduce life if very close
      if(b.position.distanceTo(camera.position) < 2.2){
        player.life -= 18 * dt;
        if(player.life <= 0) { player.life = 0; endGame(); }
      }
    }
  }
}

/* spawn loot crate at position */
function spawnLootAt(pos){
  const crate = createCrate();
  crate.position.copy(pos);
  scene.add(crate); crates.push(crate);
}

/* spawn hit effect (tiny particle) */
function spawnHitEffect(pos){
  const p = new THREE.Mesh(new THREE.SphereGeometry(0.06,6,6), new THREE.MeshStandardMaterial({ emissive:0xff6666, emissiveIntensity:1 }));
  p.position.copy(pos); p.userData={life:0.5,vel:new THREE.Vector3((Math.random()-0.5)*1.5,Math.random()*1.2, (Math.random()-0.5)*1.5)};
  scene.add(p); particles.push(p);
}

/* update particles */
function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.userData.life -= dt;
    p.position.addScaledVector(p.userData.vel, dt);
    if(p.userData.life <= 0){ scene.remove(p); particles.splice(i,1); }
  }
}

/* update zone shrink */
function updateSafeZone(){
  const now = performance.now();
  if(shrinkStep >= CONFIG.SAFE_SHRINK_STEPS) return;
  if(now - lastShrinkTime > CONFIG.SAFE_SHRINK_INTERVAL){
    // compute new target radius
    const newRadius = Math.max(CONFIG.SAFE_MIN_RADIUS, safeZone.radius * 0.6);
    safeZone.targetRadius = newRadius;
    lastShrinkTime = now;
    shrinkStep++;
    log('Zona encolheu! Novo raio: ' + Math.round(newRadius));
    // slowly animate radius over 6s
    const start = performance.now();
    const from = safeZone.radius;
    const duration = 6000;
    (function animateRadius(){
      const t = (performance.now() - start) / duration;
      if(t >= 1){ safeZone.radius = safeZone.targetRadius; return; }
      safeZone.radius = from + (safeZone.targetRadius - from) * (t);
      requestAnimationFrame(animateRadius);
    })();
  }
}

/* update crates (loot pickup) */
function updateCrates(){
  for(let i=crates.length-1;i>=0;i--){
    const c = crates[i];
    if(c.position.distanceTo(camera.position) < 1.6){
      // auto pickup: give random reward
      const loot = c.userData.loot;
      score += (loot === 'Medkit') ? 15 : 8;
      scoreEl.textContent = score;
      scene.remove(c); crates.splice(i,1);
      log('Loot coletado: ' + loot);
    }
  }
}

/* HUD helpers */
function log(txt){ logEl.textContent = txt; setTimeout(()=>{ if(logEl.textContent===txt) logEl.textContent = ''; }, 3500); }

/* main update loop */
let prevTime = performance.now();
function animate(){
  const now = performance.now();
  const dt = Math.min(0.06, (now - prevTime)/1000);
  prevTime = now;
  if(running && !paused){
    // bot spawn
    if(now - lastBotSpawn > CONFIG.BOT_SPAWN_INTERVAL && bots.length < CONFIG.MAX_BOTS){
      spawnBot(); lastBotSpawn = now;
    }
    updateProjectiles(dt);
    updateBots(dt);
    updateParticles(dt);
    updateCrates();
    updateSafeZone();
    // apply safe zone damage to player if outside
    const player2 = new THREE.Vector2(camera.position.x, camera.position.z);
    const distToCenter = player2.distanceTo(safeZone.center);
    if(distToCenter > safeZone.radius){
      const excess = distToCenter - safeZone.radius;
      player.life -= 8 * dt * Math.min(3, excess/5);
      if(player.life <= 0) { player.life = 0; endGame(); }
    }
    // update HUD
    lifeEl.textContent = Math.max(0, Math.floor(player.life));
    scoreEl.textContent = score;
    playersEl.textContent = (1 + bots.length);
    zoneEl.textContent = Math.round((safeZone.radius / CONFIG.START_SAFE_RADIUS) * 100) + '%';
    // weapon follow
    updateWeapon();
  }
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

/* weapon follow */
function updateWeapon(){
  if(!weaponMesh) return;
  const camQuat = camera.quaternion;
  const offset = new THREE.Vector3(0, -0.28, -0.65).applyQuaternion(camQuat);
  weaponMesh.position.copy(camera.position.clone().add(offset));
  weaponMesh.quaternion.slerp(camQuat, 0.25);
}

/* end game */
function endGame(){
  running = false;
  paused = true;
  panelTitle.textContent = 'Partida Finalizada';
  panelBody.innerHTML = `<p>Pontos: ${score}</p><p>Jogadores restantes: ${1 + bots.length}</p><div style="margin-top:8px"><button id="btnRespawn" class="btnMini">Reiniciar</button></div>`;
  panel.style.display = 'block';
  document.getElementById('btnRespawn').addEventListener('click', ()=> location.reload());
}

/* joystick controls */
let touching=false, startX=0, startY=0, moveX=0, moveZ=0;
joy.addEventListener('touchstart', e=>{ e.preventDefault(); touching=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; });
joy.addEventListener('touchmove', e=>{ if(!touching) return; const dx = e.touches[0].clientX - startX; const dy = e.touches[0].clientY - startY; const max = 44; const sx = Math.max(-max, Math.min(max, dx)); const sy = Math.max(-max, Math.min(max, dy)); stick.style.left = 40 + sx + 'px'; stick.style.top = 40 + sy + 'px'; moveX = sx / max; moveZ = sy / max * -1; });
joy.addEventListener('touchend', e=>{ touching=false; stick.style.left='40px'; stick.style.top='40px'; moveX=moveZ=0; });

/* map movement applied in RAF */
function movementApply(dt){
  if(!camera) return;
  const speed = player.speed * (player.sprint ? CONFIG.PLAYER_SPRINT_MULT : 1);
  const forward = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); forward.y = 0; forward.normalize();
  const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); right.y=0; right.normalize();
  const moveVec = forward.clone().multiplyScalar(moveZ).add(right.clone().multiplyScalar(moveX));
  if(moveVec.lengthSq() > 0.0001) camera.position.addScaledVector(moveVec.normalize(), speed * dt);
}

/* hook movement into animate frame */
(function movementLoop(){
  let last = performance.now();
  (function loop(){
    const now = performance.now();
    const dt = Math.min(0.06, (now - last)/1000);
    last = now;
    if(running && !paused){ movementApply(dt); }
    requestAnimationFrame(loop);
  })();
})();

/* mouse look for desktop (pointer lock) */
const pointerControls = new THREE.PointerLockControls(camera, document.body);
document.addEventListener('click', ()=> { try{ pointerControls.lock(); } catch(e){} } );

/* shooting handlers */
shootBtn.addEventListener('touchstart', e=>{ e.preventDefault(); spawnProjectile(); });
shootBtn.addEventListener('mousedown', e=>{ spawnProjectile(); });

/* simple shop */
const SHOP = [
  { id:'medkit', name:'Medkit +30', price: 40, apply: ()=>{ player.life = Math.min(CONFIG.PLAYER_MAX_LIFE, player.life + 30); } },
  { id:'speed', name:'Velocidade +3', price: 90, apply: ()=>{ player.speed += 3; } },
  { id:'ammo', name:'Munição Extra (simulada)', price: 60, apply: ()=>{ score += 5; } }
];
let playerCoins = 0; // coins earned by kills
btnShop.addEventListener('click', openShop);
closePanel.addEventListener('click', ()=>{ panel.style.display='none' });
function openShop(){
  panelTitle.textContent = 'Loja';
  panelBody.innerHTML = '';
  SHOP.forEach(it=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='8px 0';
    div.innerHTML = `<div><strong>${it.name}</strong><div style="opacity:0.75">Preço: ${it.price}</div></div><div><button class="btnMini buy" data-id="${it.id}">Comprar</button></div>`;
    panelBody.appendChild(div);
  });
  const coinsDiv = document.createElement('div'); coinsDiv.style.marginTop='8px'; coinsDiv.innerHTML = `<small>Coins: ${playerCoins}</small>`;
  panelBody.appendChild(coinsDiv);
  panel.style.display='block';
  panelTitle.scrollIntoView();
  panel.addEventListener('click', onShopClick);
}
function onShopClick(e){
  const b = e.target.closest('button.buy');
  if(!b) return;
  const id = b.dataset.id; const it = SHOP.find(x=>x.id===id);
  if(!it) return;
  if(playerCoins >= it.price){ playerCoins -= it.price; it.apply(); alert('Comprado: '+it.name); panel.style.display='none'; } else alert('Coins insuficientes!');
}

/* restart */
btnRestart.addEventListener('click', ()=> location.reload() );

/* initial start */
startBtn.addEventListener('click', ()=>{
  // resume audio context if needed for vibration/sounds (not used heavy here)
  startOverlay.style.display = 'none';
  if(!scene) initThree();
  // weapon model
  weaponMesh = createWeaponMesh(); scene.add(weaponMesh);
  // spawn initial bots (smaller number for mobile)
  const initialBots = Math.min(8, Math.floor(CONFIG.MAX_BOTS/3));
  for(let i=0;i<initialBots;i++) spawnBot();
  lastBotSpawn = performance.now();
  running = true; paused = false;
  prevTime = performance.now();
  lastShrinkTime = performance.now() + 12000; // start shrinking after 12s
  animate();
});

/* utilities */
function onResize(){ if(camera && renderer){ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); } }

/* small particle spawn for feedback on crate explosion */
function spawnCratePop(pos){
  for(let i=0;i<10;i++){
    const p = new THREE.Mesh(new THREE.SphereGeometry(0.04,6,6), new THREE.MeshStandardMaterial({ color: 0xffcc66, emissive:0xff8844 }));
    p.position.copy(pos); p.userData = { vel: new THREE.Vector3((Math.random()-0.5)*2,(Math.random()*2), (Math.random()-0.5)*2), life: 0.6 + Math.random()*0.6 };
    scene.add(p); particles.push(p);
  }
}

/* periodic cleanup (keep scene lighter) */
setInterval(()=>{ // remove far objects if any (simple)
  // no heavy cleanup for prototype
}, 12000);

/* keyboard debug (desktop) */
window.addEventListener('keydown', e=>{
  if(e.key==='t'){ USE_TEXTURES = !USE_TEXTURES; alert('Textures: '+USE_TEXTURES); }
  if(e.key==='k'){ spawnBot(); }
});

/* expose some debug API */
window.__BR = { scene, spawnBot, spawnCrateAt: spawnLootAt, CONFIG };

/* end of script */
</script>
</body>
</html>
